# nextest.toml
#
# cargo-nextest 配置文件
# 用途：配置 nextest 测试运行器的行为
#
# 文档：https://nexte.st/docs/configuration/
# 最佳实践（2026）：
# - nextest 比 cargo test 快得多（更好的并行化）
# - 在 CI/CD 中使用 nextest 获得更快的测试反馈
# - 安装：cargo install cargo-nextest
#
# 位置：
# - 项目根目录：.config/nextest.toml
# - 或直接在项目根：nextest.toml

# =====================================================================
# 测试配置
# =====================================================================

[store]
# 测试结果存储目录（相对于项目根目录）
dir = "target/nextest"

# =====================================================================
# 测试执行配置
# =====================================================================

[[profile.default]]
# 默认测试配置
# 这是运行 cargo nextest run 时使用的配置

# 测试超时（默认：300秒）
# 格式：整数（秒）或 "60s", "10m", "1h"
slow-timeout = "60s"

# 在超时后终止测试
leak-timeout = "100ms"

# 测试重试次数（默认：0，不重试）
# 对于不稳定的测试，可以设置重试次数
retry-count = 0

# 测试超时后的行为
# 选项：fail, ignore
# fail: 测试失败
# ignore: 忽略测试
# slow-timeout 的行为（选项：fail, ignore, pass）
# fail: 将慢速测试视为失败
# ignore: 忽略慢速测试
# pass: 让慢速测试通过（默认）
slow-timeout-grace-period = "10s"

# =====================================================================
# CI 配置
# =====================================================================

[[profile.ci]]
# CI 环境配置
# 使用：cargo nextest run --profile ci

# CI 中更严格的超时
slow-timeout = "30s"

# CI 中重试不稳定的测试
retry-count = 2

# CI 中的泄漏超时
leak-timeout = "5s"

# 测试终止
# 如果测试时间超过超时时间，终止测试
terminate-after = 0  # 0 表示不终止

# =====================================================================
# 性能配置
# =====================================================================

[[profile.default-overrides]]
# 为特定测试覆盖默认配置

# 例如：为慢速测试设置更长超时
# [[profile.default-overrides.'test(::slow::tests)']]
# slow-timeout = "5m"
# retry-count = 0

# =====================================================================
# 并行配置
# =====================================================================

[test-partitioning]
# 测试分区（用于并行 CI）
# 类型：count, hash-rows

# 按数量分区
# type = "count"
# count = 10  # 分成 10 个分区

# 按哈希行分区
# type = "hash-rows"
# hash-rows = 100

# =====================================================================
# JUnit 报告配置
# =====================================================================

[profile.default.junit]
# 生成 JUnit XML 报告（用于 CI/CD 集成）

# 报告输出路径
path = "target/nextest/junit.xml"

# 报告名称
report-name = "nextest-run"

# =====================================================================
# 脚本配置
# =====================================================================

[profile.default.scripts]
# 测试前后执行的脚本
# 用于设置/清理测试环境

# 测试前运行
# setup = "./scripts/setup-tests.sh"

# 测试后运行
# teardown = "./scripts/teardown-tests.sh"

# =====================================================================
# 杂项配置
# =====================================================================

[profile.default]
# 显示测试的标准输出/错误
# 选项：never, immediate, final
# never: 不显示输出
# immediate: 立即显示输出
# final: 最后显示输出（默认）
show-output = "immediate"

# 测试失败时的行为
# fail-fast = true  # 第一个测试失败后停止（默认：false）
fail-fast = false

# 最小测试间隔（用于减少资源竞争）
# 格式：整数（毫秒）
test-threads = "num-cpus"  # 使用 CPU 数量

# =====================================================================
# 高级配置
# =====================================================================

# 禁用默认的测试过滤器
# [profile.default.overrides]
# filter = "not test(_slow)"

# 使用正则表达式过滤测试
# [[profile.default.overrides.'filter']]
# match = "test(..slow)"
# skip = true

# =====================================================================
# 最佳实践提示
# =====================================================================

# 1. 本地开发：
#    cargo nextest run                    # 运行所有测试
#    cargo nextest run test_name          # 运行特定测试
#    cargo nextest run --features test-utils  # 启用 features
#
# 2. CI/CD：
#    cargo nextest run --profile ci       # 使用 CI 配置
#    cargo nextest run --partition 1:3    # 分区运行（3个分区中的第1个）
#
# 3. 查看测试输出：
#    cargo nextest run --success-output   # 显示通过的测试的输出
#
# 4. 列出测试：
#    cargo nextest list                   # 列出所有测试
#    cargo nextest list --list-type machines  # 机器可读格式
#
# 5. 性能优化：
#    - 使用 test-threads 控制并发数
#    - 使用 slow-timeout 识别慢速测试
#    - 使用 test-partitioning 在 CI 中并行运行
#
# 6. 与其他工具集成：
#    - cargo llvm-cov: cargo llvm-cov --nextest
#    - cargo-tarpaulin: cargo tarpaulin --engine=nextest
